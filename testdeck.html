<html>

<head>
  <script src="https://unpkg.com/deck.gl@~6.2.0/deckgl.min.js"></script>
  <script type="text/javascript" src="public/data/earthquake_big.js"></script>
  <!-- only if base map is needed -->
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.4/css/bulma.min.css" crossorigin="anonymous">
</head>
<style type="text/css">
.hero .nav,
.hero.is-success .nav {
  -webkit-box-shadow: none;
  box-shadow: none;
}

.hero-body {
  top: 0;
}

#container {
  /*  height: 100%;
  width: 100%;
  height: 100vh;
  width: 100vw;*/
  position: absolute;
  margin: 0;
}
</style>

<body>
  <div class="is-fullheight" id="container" style="width: 100vw; height: 100vh;"></div>
  <section class="hero is-fullheight">
    <div class="hero-head">
      <nav class="navbar">
        <!-- is-transparent -->
        <div class="container">
          <div class="navbar-brand">
            <a class="navbar-item" href="../">
              <img src="images/Logo.png" alt="Logo">
            </a>
            <span class="navbar-burger burger" data-target="navbarMenu">
              <span></span>
              <span></span>
              <span></span>
            </span>
          </div>
          <div id="navbarMenu" class="navbar-menu">
            <div class="navbar-end">
              <span class="navbar-item">
                <a class="button is-white is-outlined" href="#">
                  <span class="icon">
                    <i class="fa fa-home"></i>
                  </span>
                  <span>Home</span>
                </a>
              </span>
              <span class="navbar-item">
                <a class="button is-white is-outlined" href="#">
                  <span class="icon">
                    <i class="fa fa-superpowers"></i>
                  </span>
                  <span>Examples</span>
                </a>
              </span>
              <span class="navbar-item">
                <a class="button is-white is-outlined" href="#">
                  <span class="icon">
                    <i class="fa fa-book"></i>
                  </span>
                  <span>Documentation</span>
                </a>
              </span>
              <span class="navbar-item">
                <a class="button is-white is-outlined" href="https://github.com/dansup/bulma-templates/blob/master/templates/landing.html">
                  <span class="icon">
                    <i class="fa fa-github"></i>
                  </span>
                  <span>View Source</span>
                </a>
              </span>
            </div>
          </div>
        </div>
      </nav>
    </div>
    <div class="hero-end">
      <div class="container has-text-centered">
        <!-- <div class="box is-fullheight"></div> -->
        <div class="column is-6 is-offset-3">
          <div class="box">
            <div class="field is-grouped">
              <p class="control is-expanded">
                <input class="input" type="text" placeholder="From">
              </p>
              <!-- <p class="control" style="visibility: hidden"> -->
              <p class="control">
                <a class="button" onclick="">Click</a>
                <!-- turnOnFlag(); -->
              </p>
            </div>
            <div class="field is-grouped">
              <p class="control is-expanded">
                <input class="input" type="text" placeholder="To">
              </p>
              <p class="control">
                <a class="button is-info">Wait</a>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</body>
<script type="text/javascript">
//https://medium.com/vis-gl/start-scripting-with-deck-gl-c9036d7a6011
// deck.gl and Mapbox GL JS: Better Together
// https://medium.com/vis-gl/deckgl-and-mapbox-better-together-47b29d6d4fb1
const { MapboxLayer, ScatterplotLayer, PathLayer, IconLayer } = deck;

var start = [-74.0059731, 40.7143528]

var end = [-73.9973, 40.7308]

// Layers can be added, removed or updated at any time:
var data = data_raw["features"]


var GameTime = {
  startTime: null,
  currentTime: null,
  running: null,
  start: () => {
    this.startTime = new Date();
  },

  checkEnd: () => {
    let now = new Date();
    this.currentTime = new Date(now - this.startTime);
    return this.currentTime.getUTCHours() >= 8;
  },
  end: () => {
    clearTimeout(this.running)
  },
  run: () => {
    if (this.startTime == null) this.start();

    this.running = setInterval(() => {
      let now = new Date();

      this.currentTime = new Date(now - this.startTime);
      //Get universal time to avoid local time
      console.log(this.currentTime.getUTCHours(), this.currentTime.getUTCMinutes(), this.currentTime.getUTCSeconds())

      // console.log(typeof this.checkEnd)

      // if (this.checkEnd()) this.end();
    }, 1000);
  },
  update: (seconds) => {
    if (this.startTime == null) this.start();
    if (this.currentTime == null) this.run();
    let duration = new Date(seconds);
    this.startTime.setMinutes(this.startTime.getMinutes() - duration.getUTCMinutes());
    this.startTime.setSeconds(this.startTime.getSeconds() - duration.getUTCSeconds());

    // if (this.checkEnd()) this.end();

  }
}


var mapboxApiAccessToken = 'pk.eyJ1IjoicHJ1ZGVuY2V5eXgiLCJhIjoiY2pzaWd2MG1pMW1yZzQ5cWdleGtxdHByOCJ9._iDU8XV5SPRY2hGmVPvCKg';

mapboxgl.accessToken = mapboxApiAccessToken;

const map = new mapboxgl.Map({
  container: 'container',
  style: 'mapbox://styles/mapbox/light-v9',
  center: start,
  zoom: 13
});

//Define layers attribute
var layers = {
  scatter: undefined,
  path: undefined,
  icon: undefined,
};

//Define layers method
//otherwise 'this' is not assigned yet
layers.getlist = function() {
  return [this.scatter, this.path, this.icon].filter(ele => {
    if (ele) return true
  });
}

function updateScatterLayer(data) {
  return new MapboxLayer({
    /* unique id of this layer */
    id: 'checkins',
    type: ScatterplotLayer,
    /* data: an array of objects */
    data: data,
    /* data accessors */
    getPosition: d => d["geometry"]["coordinates"], // returns longitude, latitude, [altitude]
    getRadius: d => 10 * d["properties"]["cdi"], // returns radius in meters
    getColor: d => [255, 200, 0, 100] // returns R, G, B, [A] in 0-255 range
  })
}
// Create a mapbox-compatible deck.gl layer
const myDeckLayer = new MapboxLayer({
  id: 'my-scatterplot',
  type: ScatterplotLayer,
  data: [
    { position: end, size: 100 }
  ],
  getPosition: d => d.position,
  getRadius: d => d.size,
  getColor: [255, 0, 0]
});


function updateRouteLayer(data) {
  /**
   * Data format:
   * [
   *   {
   *     path: [[-122.4, 37.7], [-122.5, 37.8], [-122.6, 37.85]],
   *     name: 'Richmond - Millbrae',
   *     color: [255, 0, 0]
   *   },
   *   ...
   * ]
   */
  return new MapboxLayer({
    /* unique id of this layer */
    id: 'path-layer',
    type: PathLayer,
    /* data: an array of objects */
    data: data,
    /* data accessors */
    widthScale: 20,
    widthMinPixels: 2,
    rounded: true,
    getPath: d => d.coordinates,
    // getColor: d => colorToRGBArray(d.color),
    getColor: d => [0, 0, 255, 100],
    getWidth: d => 2
  })
}

function updateIconLayer(data) {
  /**
   * Data format:
   * [
   *   {name: 'Colma (COLM)', address: '365 D Street, Colma CA 94014', exits: 4214, coordinates: [-122.466233, 37.684638]},
   *   ...
   * ]
   */
  const ICON_MAPPING = {
    marker: { x: 0, y: 0, width: 32, height: 32, mask: false }
  };
  return new MapboxLayer({
    id: 'icon-layer',
    type: IconLayer,
    data,
    getIcon: d => 'marker',
    iconAtlas: 'images/car_30.png',
    iconMapping: ICON_MAPPING,
    sizeScale: 12,
    getPosition: d => d.location,
    getSize: d => 5,
    getColor: d => {
      if (d.icon == 'past') return [100, 100, 100, 150];
      return [0, 0, 0, 255]
    },
  });
}


function getRoute(input_end, cb) {
  // make a directions request using cycling profile
  // an arbitrary start will always be the same
  // only the end or destination will change
  if (input_end == start) {
    end = input_end;
  } else if (end != input_end) {
    start = end;
    end = input_end;
  }

  var url = 'https://api.mapbox.com/directions/v5/mapbox/cycling/' + start[0] + ',' + start[1] + ';' + input_end[0] + ',' + input_end[1] + '?steps=true&geometries=geojson&access_token=' + mapboxApiAccessToken;

  // make an XHR request https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest
  var req = new XMLHttpRequest();
  req.responseType = 'json';
  req.open('GET', url, true);
  req.onload = () => {
    let data = req.response
    data.waypoints[0].icon = 'past';
    data.waypoints[1].icon = 'marker';
    if (cb) cb(data);
  }

  req.send();
}

var route_layer, icon_layer;

map.on('load', function() {

  // Start time
  GameTime.start()
  GameTime.run()

  // make an initial directions request that starts and ends at the same location
  getRoute(start, data => {
    //Parse data
    let routes = [data.routes[0].geometry]
    let startEnd = data.waypoints;

    //Initialize route and icon
    route_layer = updateRouteLayer(routes);
    icon_layer = updateIconLayer(startEnd);
    map.addLayer(route_layer);
    map.addLayer(icon_layer);
  });



});

map.on('click', event => {
  //Pick a location as the new end
  let position = event.lngLat;

  getRoute([position.lng, position.lat], data => {
    //Parse data
    let routes = [data.routes[0].geometry]
    let startEnd = data.waypoints;
    // console.log(startEnd)

    //Update route and icon
    route_layer.setProps({ data: routes })
    icon_layer.setProps({ data: startEnd })

    //Update game time
    let duration = data.routes[0].duration;
    GameTime.update(duration * 1000);

    console.log()

  })
});

// The following code is based off a toggle menu by @Bradcomp
// source: https://gist.github.com/Bradcomp/a9ef2ef322a8e8017443b626208999c1
(function() {
  //Menu
  var burger = document.querySelector('.burger');
  var menu = document.querySelector('#' + burger.dataset.target);
  burger.addEventListener('click', function() {
    burger.classList.toggle('is-active');
    menu.classList.toggle('is-active');
  });

})();
</script>

</html>